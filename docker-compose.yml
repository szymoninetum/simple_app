# Docker Compose file Reference (https://docs.docker.com/compose/compose-file/)
version: '3'

#Define services
services:

  #PostgreSQL Database for the application
  app-postgres:
    image: "postgres:9.6-alpine"
    build: ./app
    container_name: app-postgres
    #Volume mounted for database for the storage
    volumes:
      - ${PWD}/app-postgres:/var/lib/postgresql/data
    ports:
      - 5432:5432 # Forward the exposed port 5432 on the container to port 5432 on the host machine

    #Environment variable for DB name, user and password
    environment:
      - POSTGRES_DB=fastapi_database
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=app
    networks:
      - app_net


#add APP service with environment variables
  app:
    image: app:latest
    build: ./app
    container_name: app

    #Environment variables for Spring Boot Application.
    environment:
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=app
      - POSTGRES_SERVER=app-postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DATABASE=fastapi_database
    ports:
      - 8000:8000 # Forward the exposed port 8080 on the container to port 8080 on the host machine
    links:
      - app-postgres
    networks:
      - app_net

  haproxy:
    image: haproxy:2.5
    command: haproxy -- /etc/haproxy/haproxy.cfg
    ports:
      - "0.0.0.0:1080:80"
      - "0.0.0.0:1081:81"
    restart: always
    volumes:
      - ${PWD}/haproxy.cfg:/etc/haproxy/haproxy.cfg
    networks:
      - app_net

volumes:
  app-postgres:

networks:
  app_net:
